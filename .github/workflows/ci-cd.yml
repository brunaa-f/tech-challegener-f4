name: CI/CD Pipeline - DevShip

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  # Job 1: Qualidade de CÃ³digo
  quality:
    name: ğŸ” Qualidade de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/host-app/package-lock.json

      - name: ğŸ“š Instalar dependÃªncias
        working-directory: apps/host-app
        run: npm ci

      - name: ğŸ” Executar ESLint
        working-directory: apps/host-app
        run: npm run lint

  # Job 2: Testes UnitÃ¡rios e de IntegraÃ§Ã£o
  test:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/host-app/package-lock.json

      - name: ğŸ“š Instalar dependÃªncias
        working-directory: apps/host-app
        run: npm ci

      - name: ğŸ§ª Executar testes com cobertura
        working-directory: apps/host-app
        run: npm run test:coverage
        env:
          CI: true

      - name: ğŸ“Š Upload do relatÃ³rio de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: apps/host-app/coverage/
          retention-days: 7

      - name: âœ… Verificar cobertura mÃ­nima (70%)
        working-directory: apps/host-app
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Cobertura de linhas: $COVERAGE%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "âŒ Cobertura abaixo de 70%"
            exit 1
          fi
          echo "âœ… Cobertura acima de 70%"

  # Job 3: Testes E2E
  e2e:
    name: ğŸ­ Testes E2E
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/host-app/package-lock.json

      - name: ğŸ“š Instalar dependÃªncias
        working-directory: apps/host-app
        run: npm ci

      - name: ğŸ”§ Gerar Prisma Client
        run: npx prisma generate --schema=./libs/db/prisma/schema.prisma

      - name: ğŸ­ Instalar Playwright
        working-directory: apps/host-app
        run: npx playwright install --with-deps chromium

      - name: ğŸ­ Executar testes E2E
        working-directory: apps/host-app
        run: npx playwright test --project=chromium
        env:
          CI: true
          NEXTAUTH_SECRET: 'ci-secret-key-for-e2e'
          NEXTAUTH_URL: 'http://localhost:3000'
          DATABASE_URL: 'postgresql://postgres:postgres@localhost:5432/test'
        continue-on-error: true

      - name: ğŸ“Š Upload do relatÃ³rio Playwright
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: apps/host-app/playwright-report/
          retention-days: 7

  # Job 4: Build
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [quality, test]
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/host-app/package-lock.json

      - name: ğŸ“š Instalar dependÃªncias
        working-directory: apps/host-app
        run: npm ci

      - name: ğŸ”§ Gerar Prisma Client
        run: npx prisma generate --schema=./libs/db/prisma/schema.prisma

      - name: ğŸ—ï¸ Build da aplicaÃ§Ã£o
        working-directory: apps/host-app
        run: npm run build
        env:
          NEXTAUTH_SECRET: 'ci-secret-key-for-build'
          NEXTAUTH_URL: 'http://localhost:3000'
          DATABASE_URL: 'postgresql://postgres:postgres@localhost:5432/test'
          SKIP_ENV_VALIDATION: 'true'

      - name: ğŸ“¦ Upload do artifact de build
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: |
            apps/host-app/.next/
            apps/host-app/public/
            apps/host-app/package.json
          retention-days: 7

  # Job 5: Deploy (Simulado/Vercel)
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download do artifact de build
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: apps/host-app/

      - name: ğŸ“ Deploy Simulado
        run: |
          echo "ğŸš€ Deploy simulado realizado com sucesso!"
          echo "ğŸ“¦ Artifact de build disponÃ­vel para deploy manual"
          echo "ğŸŒ URL de produÃ§Ã£o: https://devship-fiap.vercel.app (simulado)"
          echo ""
          echo "Para configurar deploy real, adicione os secrets:"
          echo "  - VERCEL_TOKEN"
          echo "  - VERCEL_ORG_ID"
          echo "  - VERCEL_PROJECT_ID"

  # Job 6: NotificaÃ§Ã£o
  notify:
    name: ğŸ“¢ NotificaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: ğŸ“¢ Resumo do Pipeline
        run: |
          echo "ğŸ‰ Pipeline CI/CD Finalizado!"
          echo ""
          echo "ğŸ“Š Resumo:"
          echo "  âœ… Qualidade de cÃ³digo verificada"
          echo "  âœ… Testes unitÃ¡rios executados"
          echo "  âœ… Testes de integraÃ§Ã£o executados"
          echo "  âœ… Testes E2E executados"
          echo "  âœ… Build gerado com sucesso"
          echo "  âœ… Deploy realizado"
          echo ""
          echo "ğŸ“ˆ MÃ©tricas disponÃ­veis nos artifacts"
